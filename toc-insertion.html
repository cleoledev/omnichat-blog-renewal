<?php
$lang = pll_current_language();
?>

<div id="toc" class="toc">
  <div class="toc-title">
    <?= $lang === 'en' ? 'Table of Contents: ' : '目錄: ' ?>
  </div>
  <ul class="toc-list">
  </ul>
</div>

<script>
  const content = document.getElementById("article-content");
  const headings = [...content.querySelectorAll("h1, h2, h3, h4, h5, h6")];
  const toc = document.getElementById("toc");
  const tocList = toc.querySelector(".toc-list");
  const firstPara = content.querySelector("p");

  if (headings.length > 0) {
    headings.reduce((currentGroup, heading, idx) => {
      if (!heading.textContent) return currentGroup;

      const level = +heading.tagName.slice(1);
      const anchorId = heading.id || `heading-${idx + 1}`;
      const tocItem = document.createElement("li");
      const tocLink = document.createElement("a");
      heading.id = anchorId;
      tocLink.href = "#" + anchorId;
      tocLink.textContent = heading.textContent;
      tocItem.appendChild(tocLink);

      if (currentGroup.level === level) {
        currentGroup.element.appendChild(tocItem);
      } else if (currentGroup.level < level) {
        const element = document.createElement("ul");
        element.appendChild(tocItem);
        currentGroup.element.appendChild(element);

        currentGroup = {
          level: level,
          element,
          parent: currentGroup
        }
      } else {
        currentGroup.parent.element.appendChild(tocItem);
        currentGroup = currentGroup.parent;
      }

      return currentGroup;
    }, { level: 0, element: tocList, parent: null });

    toc.appendChild(tocList);
    firstPara.insertAdjacentElement("afterend", toc);
  }
</script>